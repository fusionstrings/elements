<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elements &ndash; Standard Web Components</title>

    <template id="template-counter">
      <style>
        div {
          font-family:
            "Gill Sans", "Gill Sans MT", Calibri, "Trebuchet MS", sans-serif;
        }
      </style>
      <div>
        <slot></slot>
      </div>
    </template>

    <template id="template-button">
      <style>
        button {
          background-color: #4caf50; /* Green */
          border: none;
          color: white;
          padding: 15px 32px;
          text-align: center;
          text-decoration: none;
          display: inline-block;
          font-size: 16px;
          margin: 4px 2px;
          cursor: pointer;
        }
      </style>
      <button type="button">
        <slot></slot>
      </button>
    </template>

    <script type="module">
      const createSignal = (value) => {
        const subscribers = new Set();
        const signal = {
          get value() {
            return value;
          },
          set value(newValue) {
            value = newValue;
            for (const subscriber of subscribers) {
              subscriber(value);
            }
          },
          subscribe(subscriber) {
            subscribers.add(subscriber);
            return () => subscribers.delete(subscriber);
          },
        };
        return signal;
      };

      const count = createSignal(0);

      class Counter extends HTMLElement {
        shadow = null;
        internals;
        counterPlaceholder = null;
        disposeEffect;
        constructor() {
          super();
          if ("attachInternals" in this) {
            this.internals = this.attachInternals();
          }
        }
        connectedCallback() {
          this.shadow = this.internals?.shadowRoot || this.shadowRoot;
          if (!this.shadow) {
            this.shadow = this.attachShadow({
              mode: "open",
            });
            const template = document.getElementById(
              "template-counter",
            );
            if (template) {
              this.shadow.appendChild(template.content.cloneNode(true));
            }
          }
          this.counterPlaceholder = this.shadow?.querySelector("div");
          if (this.counterPlaceholder) {
            // Store disposer to clean up effect on disconnect
            this.disposeEffect = count.subscribe((value) => {
              this.counterPlaceholder.textContent = `${value}`;
            });
          }
        }
        disconnectedCallback() {
          if (this.disposeEffect) {
            this.disposeEffect();
            this.disposeEffect = undefined;
          }
        }
      }

      class Button extends HTMLElement {
        shadow = null;
        internals;
        buttonEl = null;
        handleClick = () => {
          count.value++;
        };
        constructor() {
          super();
          if ("attachInternals" in this) {
            this.internals = this.attachInternals();
          }
        }
        connectedCallback() {
          this.shadow = this.internals?.shadowRoot || this.shadowRoot;
          if (!this.shadow) {
            this.shadow = this.attachShadow({
              mode: "open",
            });
            const template = document.getElementById("template-button");
            if (template) {
              this.shadow.appendChild(template.content.cloneNode(true));
            }
          }
          // Attach event listener
          this.buttonEl = this.shadow?.querySelector("button");
          if (this.buttonEl) {
            this.buttonEl.addEventListener("click", this.handleClick);
          }
        }
        disconnectedCallback() {
          if (this.buttonEl) {
            this.buttonEl.removeEventListener(
              "click",
              this.handleClick,
            );
          }
        }
      }
      customElements.define("element-counter", Counter);
      customElements.define("element-button", Button);
    </script>
  </head>
  <body>
    <h1>Standard Web Components</h1>
    <nav>
      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/preact-web-components">Preact Web Components</a></li>
      </ul>
    </nav>
    <main>
      <form onsubmit="return false;">
        <fieldset>
          <legend>Counter Form</legend>
          <p>
            Current count: <element-counter>0</element-counter>
          </p>
          <element-button>Increment</element-button>
        </fieldset>
      </form>
    </main>

    <footer>
      <h2>References</h2>
      <ul>
        <li>
          <a
            href="https://html.spec.whatwg.org/multipage/scripting.html#attr-template-shadowrootmode"
          >Declarative Shadow DOM Specs</a>
        </li>
        <li>
          <a href="https://web.dev/articles/declarative-shadow-dom"
          >Declarative Shadow DOM by Jason Miller and Mason Freed</a>
        </li>
        <li>
          <a href="https://jakelazaroff.com/words/isomorphic-web-components/"
          >Isomorphic Web Components by Jake Lazaroff</a>
        </li>
        <li>
          <a href="https://github.com/mayank99/declarative-shadow-dom"
          >Utility to get Declarative Shadow Dom work in JSX</a>
        </li>
        <li>
          <a
            href="https://www.konnorrogers.com/posts/2023/what-is-declarative-shadow-dom"
          >What is DSD</a>
        </li>
        <li>
          <a href="https://12daysofweb.dev/2024/declarative-shadow-dom/">DSD</a>
        </li>
        <li>
          <a href="https://fullystacked.net/declarative-shadow-dom/"
          >Declarative Shadow DOM and issue in React</a>
        </li>
        <li>
          <a
            href="https://blog.stackademic.com/server-rendering-web-components-in-react-869c248f1df7"
          >Declarative Shadow DOM and issue in SSR</a>
        </li>
        <li>
          <a href="https://fullystacked.net/innerhtml-alternatives/"
          >Some useful modern browser APIs for Web components</a>
        </li>
        <li>
          <a href="https://github.com/solidjs/solid/issues/1834"
          >Solid JS DSD issue</a>
        </li>
      </ul>
    </footer>
  </body>
</html>
